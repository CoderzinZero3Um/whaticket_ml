'use strict';const a631_0x2729cd=a631_0x3826;(function(_0x4f6be0,_0x57c2f4){const _0x1711c1=a631_0x3826,_0x197c17=_0x4f6be0();while(!![]){try{const _0xe69c8a=parseInt(_0x1711c1(0x1f9))/0x1*(-parseInt(_0x1711c1(0x23f))/0x2)+parseInt(_0x1711c1(0x201))/0x3*(parseInt(_0x1711c1(0x229))/0x4)+parseInt(_0x1711c1(0x22e))/0x5*(parseInt(_0x1711c1(0x21b))/0x6)+-parseInt(_0x1711c1(0x1fb))/0x7*(-parseInt(_0x1711c1(0x21f))/0x8)+parseInt(_0x1711c1(0x22c))/0x9*(-parseInt(_0x1711c1(0x21c))/0xa)+parseInt(_0x1711c1(0x226))/0xb*(parseInt(_0x1711c1(0x217))/0xc)+parseInt(_0x1711c1(0x208))/0xd*(-parseInt(_0x1711c1(0x250))/0xe);if(_0xe69c8a===_0x57c2f4)break;else _0x197c17['push'](_0x197c17['shift']());}catch(_0x341fe9){_0x197c17['push'](_0x197c17['shift']());}}}(a631_0x3d12,0xa1d5f));function a631_0x3d12(){const _0x2b46f8=['./FindOrCreateATicketTrakingService','22206OYdnXs','map','farewellMessage','transfered','*\x20e\x20será\x20atendido\x20por\x20*','\x22*\x0aAguarde\x20um\x20momento,\x20iremos\x20atende-lo(a)!','call','isGroup','group','./ShowTicketService','isNil','verifyMessageFace','\x20is\x20a\x20valid\x20','\x20contact','default','closedAt','../UserServices/ShowUserService','42hNkRVV','../../models/Tag','delete','-ticket','../WbotServices/wbotMessageListener','log','../../helpers/GetTicketWbot','Checking\x20if\x20','contact','verifyMessage','captureException','g.us','configurable','enabled','findOne','facebook','user','pending','remoteJid','__esModule','queueOptionId','getOwnPropertyDescriptor','entrou\x20no\x20send\x20message','sendFarewellWaitingTicket','../../models/Ticket','../../models/CompaniesSettings','../../models/TicketTag','16MvGeYm','open','91IwzwvA','toDate','userId','indexOf','../../models/User','sendMessage','1185627nsCZJM','prototype','lastMessage','‎*Mensagem\x20Automática*:\x0aVocê\x20foi\x20transferido(a)\x20para\x20o\x20atendente\x20*','companyId','findAll','typebotSessionId','5592769UJUrcP','updatedAt','__setModuleDefault','extendedTextMessage','../../models/Queue','queuedAt','getIO','nps','toString','../WbotServices/SendWhatsAppMessage','__importStar','s.whatsapp.net','../MessageServices/CreateMessageService','findByPk','save','180nVSWFR','closed','reload','receivedTransfer','48948hYjiPn','170tIpUdZ','emit','update','548824ZIAshT','amountUsedBotQueues','notification','company-','isBot','get','closeTicket','312730LyUMkN','whatsapp','queueId','4kuNOfD','instagram','replace','120078BmsDHY','whatsappId','395YdcZiM','number','channel','defineProperty','includes','finishedAt','status','‎*Mensagem\x20Automática*:\x0aVocê\x20foi\x20transferido(a)\x20para\x20o\x20departamento\x20*','*\x0aAguarde\x20um\x20momento,\x20iremos\x20atende-lo(a)!','closeTicketOnTransfer','create','../../helpers/SetTicketMessagesAsRead','sendMsgTransfTicket','contactId','name','writable'];a631_0x3d12=function(){return _0x2b46f8;};return a631_0x3d12();}var __createBinding=this&&this['__createBinding']||(Object[a631_0x2729cd(0x238)]?function(_0x5aaef4,_0x4e254f,_0x27eeac,_0x3b27ba){const _0x59f038=a631_0x2729cd;if(_0x3b27ba===undefined)_0x3b27ba=_0x27eeac;var _0x730b92=Object[_0x59f038(0x1f3)](_0x4e254f,_0x27eeac);(!_0x730b92||(_0x59f038(0x224)in _0x730b92?!_0x4e254f['__esModule']:_0x730b92[_0x59f038(0x23d)]||_0x730b92[_0x59f038(0x25c)]))&&(_0x730b92={'enumerable':!![],'get':function(){return _0x4e254f[_0x27eeac];}}),Object[_0x59f038(0x231)](_0x5aaef4,_0x3b27ba,_0x730b92);}:function(_0x39a6f0,_0x4c0555,_0xe39f28,_0x2fc733){if(_0x2fc733===undefined)_0x2fc733=_0xe39f28;_0x39a6f0[_0x2fc733]=_0x4c0555[_0xe39f28];}),__setModuleDefault=this&&this[a631_0x2729cd(0x20a)]||(Object[a631_0x2729cd(0x238)]?function(_0x2f7f34,_0x42678d){const _0xef2307=a631_0x2729cd;Object[_0xef2307(0x231)](_0x2f7f34,_0xef2307(0x24d),{'enumerable':!![],'value':_0x42678d});}:function(_0x4bb744,_0x355b59){_0x4bb744['default']=_0x355b59;}),__importStar=this&&this[a631_0x2729cd(0x212)]||function(_0x5aaa64){const _0x53abb1=a631_0x2729cd;if(_0x5aaa64&&_0x5aaa64[_0x53abb1(0x263)])return _0x5aaa64;var _0x2d90f1={};if(_0x5aaa64!=null){for(var _0x1c2b1b in _0x5aaa64)if(_0x1c2b1b!==_0x53abb1(0x24d)&&Object[_0x53abb1(0x202)]['hasOwnProperty'][_0x53abb1(0x245)](_0x5aaa64,_0x1c2b1b))__createBinding(_0x2d90f1,_0x5aaa64,_0x1c2b1b);}return __setModuleDefault(_0x2d90f1,_0x5aaa64),_0x2d90f1;},__importDefault=this&&this['__importDefault']||function(_0x3a88b7){const _0x23560b=a631_0x2729cd;return _0x3a88b7&&_0x3a88b7[_0x23560b(0x263)]?_0x3a88b7:{'default':_0x3a88b7};};Object[a631_0x2729cd(0x231)](exports,'__esModule',{'value':!![]});const moment_1=__importDefault(require('moment')),Sentry=__importStar(require('@sentry/node')),sequelize_1=require('sequelize'),SetTicketMessagesAsRead_1=__importDefault(require(a631_0x2729cd(0x239))),socket_1=require('../../libs/socket'),Ticket_1=__importDefault(require(a631_0x2729cd(0x1f6))),Queue_1=__importDefault(require(a631_0x2729cd(0x20c))),ShowTicketService_1=__importDefault(require(a631_0x2729cd(0x248))),ShowWhatsAppService_1=__importDefault(require('../WhatsappService/ShowWhatsAppService')),SendWhatsAppMessage_1=__importDefault(require(a631_0x2729cd(0x211))),FindOrCreateATicketTrakingService_1=__importDefault(require(a631_0x2729cd(0x23e))),GetTicketWbot_1=__importDefault(require(a631_0x2729cd(0x256))),wbotMessageListener_1=require(a631_0x2729cd(0x254)),lodash_1=require('lodash'),sendFacebookMessage_1=__importDefault(require('../FacebookServices/sendFacebookMessage')),facebookMessageListener_1=require('../FacebookServices/facebookMessageListener'),ShowUserService_1=__importDefault(require(a631_0x2729cd(0x24f))),User_1=__importDefault(require(a631_0x2729cd(0x1ff))),CompaniesSettings_1=__importDefault(require(a631_0x2729cd(0x1f7))),CreateLogTicketService_1=__importDefault(require('./CreateLogTicketService')),TicketTag_1=__importDefault(require(a631_0x2729cd(0x1f8))),Tag_1=__importDefault(require(a631_0x2729cd(0x251))),CreateMessageService_1=__importDefault(require(a631_0x2729cd(0x214))),FindOrCreateTicketService_1=__importDefault(require('./FindOrCreateTicketService')),UpdateTicketService=async({ticketData:_0x4b663e,ticketId:_0x449b49,companyId:_0x1e49c6})=>{const _0x265251=a631_0x2729cd;try{let {status:_0x1edae3}=_0x4b663e,{queueId:_0x2dbce8,userId:_0x4003f7,sendFarewellMessage:sendFarewellMessage=!![],amountUsedBotQueues:_0x1219aa,lastMessage:_0x591e2b,integrationId:_0x11981e,useIntegration:_0x550a55,unreadMessages:_0x38a081,msgTransfer:_0x2d544b,isTransfered:isTransfered=![]}=_0x4b663e,_0x253faf=_0x4b663e[_0x265251(0x223)]||![],_0x730e70=_0x4b663e[_0x265251(0x264)]||null;const _0x2904dc=(0x0,socket_1[_0x265251(0x20e)])(),_0x1b51d3=await CompaniesSettings_1[_0x265251(0x24d)][_0x265251(0x25e)]({'where':{'companyId':_0x1e49c6}});let _0x349016=await(0x0,ShowTicketService_1[_0x265251(0x24d)])(_0x449b49,_0x1e49c6);_0x349016[_0x265251(0x230)]===_0x265251(0x227)&&await(0x0,SetTicketMessagesAsRead_1[_0x265251(0x24d)])(_0x349016);const _0x366bfd=_0x349016?.[_0x265251(0x234)],_0x617d3e=_0x349016[_0x265251(0x260)]?.['id'],_0x50ea74=_0x349016?.[_0x265251(0x228)];if((0x0,lodash_1[_0x265251(0x249)])(_0x349016['whatsappId'])&&_0x1edae3===_0x265251(0x218)&&[_0x265251(0x25f),_0x265251(0x22a)]['includes'](_0x349016[_0x265251(0x230)]))return await(0x0,CreateLogTicketService_1[_0x265251(0x24d)])({'userId':_0x4003f7,'queueId':_0x349016[_0x265251(0x228)],'ticketId':_0x449b49,'type':'closed'}),await _0x349016[_0x265251(0x21e)]({'status':_0x265251(0x218)}),_0x2904dc['to'](_0x366bfd)['to'](_0x449b49[_0x265251(0x210)]())[_0x265251(0x21d)](_0x265251(0x222)+_0x349016['companyId']+_0x265251(0x253),{'action':_0x265251(0x252),'ticketId':_0x349016['id']}),{'ticket':_0x349016,'oldStatus':_0x366bfd,'oldUserId':_0x617d3e};if(_0x366bfd===_0x265251(0x218)){let _0x255146=await Ticket_1[_0x265251(0x24d)][_0x265251(0x25e)]({'where':{'contactId':_0x349016[_0x265251(0x23b)],'status':{[sequelize_1['Op']['or']]:['open',_0x265251(0x261),_0x265251(0x247)]},'whatsappId':_0x349016[_0x265251(0x22d)]}});if(_0x255146){if(_0x255146['id']!==_0x349016['id'])return _0x255146=await(0x0,ShowTicketService_1[_0x265251(0x24d)])(_0x255146['id'],_0x1e49c6),{'ticket':_0x255146,'oldStatus':_0x366bfd,'oldUserId':_0x617d3e};}_0x253faf=![];}const _0x538ac5=await(0x0,FindOrCreateATicketTrakingService_1['default'])({'ticketId':_0x449b49,'companyId':_0x1e49c6,'whatsappId':_0x349016?.[_0x265251(0x22d)]}),{complationMessage:_0x1e6290,ratingMessage:_0xa1bd7f,groupAsTicket:_0x29bf91}=await(0x0,ShowWhatsAppService_1[_0x265251(0x24d)])(_0x349016?.['whatsappId'],_0x1e49c6);if(_0x1edae3!==undefined&&['closed'][_0x265251(0x1fe)](_0x1edae3)>-0x1){const _0x516d31=_0x349016['userId']||_0x4003f7,_0x15b28b=await User_1[_0x265251(0x24d)][_0x265251(0x215)](_0x516d31);if(_0x1b51d3['userRating']===_0x265251(0x25d)&&(sendFarewellMessage||sendFarewellMessage===undefined)&&(!(0x0,lodash_1['isNil'])(_0xa1bd7f)&&_0xa1bd7f!=='')&&!_0x349016['isGroup']){if(_0x538ac5['ratingAt']==null){const _0x1fcf82=_0xa1bd7f||'';let _0x331598='‎\x20'+_0x1fcf82+'\x0a';if(_0x349016[_0x265251(0x230)]===_0x265251(0x227)){const _0x403368=await(0x0,SendWhatsAppMessage_1[_0x265251(0x24d)])({'body':_0x331598,'ticket':_0x349016,'isForwarded':![]});await(0x0,wbotMessageListener_1[_0x265251(0x259)])(_0x403368,_0x349016,_0x349016['contact']);}else{if([_0x265251(0x25f),'instagram'][_0x265251(0x232)](_0x349016[_0x265251(0x230)])){console['log'](_0x265251(0x257)+_0x349016[_0x265251(0x258)][_0x265251(0x22f)]+'\x20is\x20a\x20valid\x20'+_0x349016[_0x265251(0x230)]+_0x265251(0x24c));const _0x5f1566=await(0x0,sendFacebookMessage_1['default'])({'body':_0x331598,'ticket':_0x349016});await(0x0,facebookMessageListener_1[_0x265251(0x24a)])(_0x5f1566,_0x331598,_0x349016,_0x349016[_0x265251(0x258)]);}}await _0x538ac5[_0x265251(0x21e)]({'userId':_0x349016[_0x265251(0x1fd)],'closedAt':(0x0,moment_1[_0x265251(0x24d)])()[_0x265251(0x1fc)]()}),await(0x0,CreateLogTicketService_1[_0x265251(0x24d)])({'userId':_0x349016[_0x265251(0x1fd)],'queueId':_0x349016[_0x265251(0x228)],'ticketId':_0x449b49,'type':_0x265251(0x20f)});try{const _0x312330=await TicketTag_1[_0x265251(0x24d)][_0x265251(0x206)]({'where':{'ticketId':_0x449b49}}),_0x3712ec=_0x312330['map'](_0x33abb4=>_0x33abb4['tagId']),_0x24afed=await Tag_1['default']['findAll']({'where':{'id':_0x3712ec,'kanban':0x1}}),_0x4e8620=_0x24afed[_0x265251(0x240)](_0x225ada=>_0x225ada['id']);if(_0x4e8620)await TicketTag_1[_0x265251(0x24d)]['destroy']({'where':{'ticketId':_0x449b49,'tagId':_0x4e8620}});}catch(_0x10744e){Sentry['captureException'](_0x10744e);}return await _0x349016[_0x265251(0x21e)]({'status':_0x265251(0x20f),'amountUsedBotQueuesNPS':0x1}),_0x2904dc['to']('open')['to'](_0x449b49[_0x265251(0x210)]())[_0x265251(0x21d)](_0x265251(0x222)+_0x349016[_0x265251(0x205)]+'-ticket',{'action':'delete','ticketId':_0x349016['id']}),{'ticket':_0x349016,'oldStatus':_0x366bfd,'oldUserId':_0x617d3e};}}if((!(0x0,lodash_1[_0x265251(0x249)])(_0x15b28b?.[_0x265251(0x241)])&&_0x15b28b?.['farewellMessage']!==''||!(0x0,lodash_1[_0x265251(0x249)])(_0x1e6290)&&_0x1e6290!=='')&&(sendFarewellMessage||sendFarewellMessage===undefined)){let _0x2aaa90;if(_0x349016[_0x265251(0x234)]!=='pending'||_0x349016['status']===_0x265251(0x261)&&_0x1b51d3[_0x265251(0x1f5)]===_0x265251(0x25d)){!(0x0,lodash_1['isNil'])(_0x15b28b)&&!(0x0,lodash_1['isNil'])(_0x15b28b?.[_0x265251(0x241)])&&_0x15b28b?.[_0x265251(0x241)]!==''?_0x2aaa90='‎\x20'+_0x15b28b[_0x265251(0x241)]:_0x2aaa90='‎\x20'+_0x1e6290;if(_0x349016['channel']===_0x265251(0x227)&&(!_0x349016['isGroup']||_0x29bf91==='enabled')){console[_0x265251(0x255)](_0x265251(0x1f4));const _0xf1bbe6=await(0x0,SendWhatsAppMessage_1[_0x265251(0x24d)])({'body':_0x2aaa90,'ticket':_0x349016,'isForwarded':![]});await(0x0,wbotMessageListener_1['verifyMessage'])(_0xf1bbe6,_0x349016,_0x349016['contact']);}if([_0x265251(0x25f),_0x265251(0x22a)]['includes'](_0x349016['channel'])&&(!_0x349016[_0x265251(0x246)]||_0x29bf91===_0x265251(0x25d))){console[_0x265251(0x255)](_0x265251(0x257)+_0x349016[_0x265251(0x258)]['number']+_0x265251(0x24b)+_0x349016['channel']+_0x265251(0x24c));const _0x55ae28=await(0x0,sendFacebookMessage_1[_0x265251(0x24d)])({'body':_0x2aaa90,'ticket':_0x349016});}}}return _0x538ac5[_0x265251(0x233)]=(0x0,moment_1[_0x265251(0x24d)])()[_0x265251(0x1fc)](),_0x538ac5[_0x265251(0x24e)]=(0x0,moment_1[_0x265251(0x24d)])()[_0x265251(0x1fc)](),_0x538ac5['whatsappId']=_0x349016?.[_0x265251(0x22d)],_0x538ac5[_0x265251(0x1fd)]=_0x349016[_0x265251(0x1fd)],await(0x0,CreateLogTicketService_1[_0x265251(0x24d)])({'userId':_0x4003f7,'queueId':_0x349016['queueId'],'ticketId':_0x449b49,'type':_0x265251(0x218)}),await _0x538ac5[_0x265251(0x216)](),await _0x349016['update']({'status':_0x265251(0x218)}),_0x2904dc['to'](_0x366bfd)['to'](_0x449b49[_0x265251(0x210)]())[_0x265251(0x21d)](_0x265251(0x222)+_0x349016[_0x265251(0x205)]+'-ticket',{'action':_0x265251(0x252),'ticketId':_0x349016['id']}),{'ticket':_0x349016,'oldStatus':_0x366bfd,'oldUserId':_0x617d3e};}let _0x571ce2;!(0x0,lodash_1[_0x265251(0x249)])(_0x2dbce8)&&(_0x571ce2=await Queue_1[_0x265251(0x24d)][_0x265251(0x215)](_0x2dbce8),_0x538ac5['queuedAt']=(0x0,moment_1[_0x265251(0x24d)])()[_0x265251(0x1fc)]());if(isTransfered){if(_0x1b51d3[_0x265251(0x237)]){let _0x1d4ada=_0x349016;if(_0x50ea74!==_0x2dbce8){await _0x349016[_0x265251(0x21e)]({'status':_0x265251(0x218)}),await _0x349016[_0x265251(0x219)](),_0x2904dc['to'](_0x366bfd)['to'](_0x449b49['toString']())[_0x265251(0x21d)]('company-'+_0x349016['companyId']+_0x265251(0x253),{'action':_0x265251(0x252),'ticketId':_0x349016['id']});const {ticket:_0x4e0d45}=await(0x0,FindOrCreateTicketService_1[_0x265251(0x24d)])(_0x349016[_0x265251(0x258)],_0x349016[_0x265251(0x227)],0x1,_0x349016[_0x265251(0x205)],_0x2dbce8,_0x4003f7,null,_0x265251(0x227),![],![],_0x1b51d3,isTransfered);_0x1d4ada=_0x4e0d45;}if(!(0x0,lodash_1['isNil'])(_0x2d544b)){const _0x58dd34={'wid':'PVT'+_0x1d4ada[_0x265251(0x209)][_0x265251(0x210)]()[_0x265251(0x22b)]('\x20',''),'ticketId':_0x1d4ada['id'],'contactId':undefined,'body':_0x2d544b,'fromMe':!![],'mediaType':_0x265251(0x20b),'read':!![],'quotedMsgId':null,'ack':0x2,'remoteJid':_0x1d4ada['contact']?.[_0x265251(0x262)],'participant':null,'dataJson':null,'ticketTrakingId':null,'isPrivate':!![]};await(0x0,CreateMessageService_1[_0x265251(0x24d)])({'messageData':_0x58dd34,'companyId':_0x349016['companyId']});}await _0x1d4ada['update']({'queueId':_0x2dbce8,'userId':_0x4003f7,'status':_0x1edae3}),await _0x1d4ada[_0x265251(0x219)]();if(_0x1b51d3[_0x265251(0x23a)]==='enabled'){if(_0x50ea74!==_0x2dbce8&&_0x617d3e===_0x4003f7&&!(0x0,lodash_1['isNil'])(_0x50ea74)&&!(0x0,lodash_1['isNil'])(_0x2dbce8)){const _0x442720=await(0x0,GetTicketWbot_1[_0x265251(0x24d)])(_0x349016),_0x621a6f=_0x265251(0x235)+_0x571ce2?.[_0x265251(0x23c)]+_0x265251(0x244),_0x547431=await _0x442720[_0x265251(0x200)](_0x349016[_0x265251(0x258)][_0x265251(0x22f)]+'@'+(_0x349016[_0x265251(0x246)]?'g.us':'s.whatsapp.net'),{'text':_0x621a6f});await(0x0,wbotMessageListener_1[_0x265251(0x259)])(_0x547431,_0x349016,_0x349016[_0x265251(0x258)],_0x538ac5);}else{if(_0x617d3e!==_0x4003f7&&_0x50ea74===_0x2dbce8&&!(0x0,lodash_1[_0x265251(0x249)])(_0x617d3e)&&!(0x0,lodash_1[_0x265251(0x249)])(_0x4003f7)&&(!_0x349016[_0x265251(0x246)]||_0x29bf91===_0x265251(0x25d))){const _0x2b7496=await(0x0,GetTicketWbot_1[_0x265251(0x24d)])(_0x349016),_0x18be77=await(0x0,ShowUserService_1[_0x265251(0x24d)])(_0x4b663e['userId'],_0x1e49c6),_0x576c63=_0x265251(0x204)+_0x18be77[_0x265251(0x23c)]+_0x265251(0x236),_0x396e31=await _0x2b7496[_0x265251(0x200)](_0x349016[_0x265251(0x258)][_0x265251(0x22f)]+'@'+(_0x349016[_0x265251(0x246)]?'g.us':_0x265251(0x213)),{'text':_0x576c63});await(0x0,wbotMessageListener_1[_0x265251(0x259)])(_0x396e31,_0x349016,_0x349016['contact'],_0x538ac5);}else{if(_0x617d3e!==_0x4003f7&&_0x50ea74!==_0x2dbce8&&!(0x0,lodash_1[_0x265251(0x249)])(_0x617d3e)&&!(0x0,lodash_1[_0x265251(0x249)])(_0x4003f7)&&(!_0x349016['isGroup']||_0x29bf91==='enabled')){const _0x5c9116=await(0x0,GetTicketWbot_1[_0x265251(0x24d)])(_0x349016),_0x6ea849=await(0x0,ShowUserService_1[_0x265251(0x24d)])(_0x4b663e[_0x265251(0x1fd)],_0x1e49c6),_0x5213c3=_0x265251(0x235)+_0x571ce2?.[_0x265251(0x23c)]+_0x265251(0x243)+_0x6ea849['name']+_0x265251(0x236),_0x28e320=await _0x5c9116[_0x265251(0x200)](_0x349016[_0x265251(0x258)]['number']+'@'+(_0x349016[_0x265251(0x246)]?_0x265251(0x25b):_0x265251(0x213)),{'text':_0x5213c3});await(0x0,wbotMessageListener_1[_0x265251(0x259)])(_0x28e320,_0x349016,_0x349016[_0x265251(0x258)]);}else{if(_0x617d3e!==undefined&&(0x0,lodash_1['isNil'])(_0x4003f7)&&_0x50ea74!==_0x2dbce8&&!(0x0,lodash_1[_0x265251(0x249)])(_0x2dbce8)){const _0x30f187=await(0x0,GetTicketWbot_1[_0x265251(0x24d)])(_0x349016),_0x2f7359=_0x265251(0x235)+_0x571ce2?.[_0x265251(0x23c)]+_0x265251(0x236),_0x1acc2f=await _0x30f187[_0x265251(0x200)](_0x349016[_0x265251(0x258)][_0x265251(0x22f)]+'@'+(_0x349016[_0x265251(0x246)]?_0x265251(0x25b):'s.whatsapp.net'),{'text':_0x2f7359});await(0x0,wbotMessageListener_1[_0x265251(0x259)])(_0x1acc2f,_0x349016,_0x349016[_0x265251(0x258)]);}}}}}if(_0x617d3e!==_0x4003f7&&_0x50ea74===_0x2dbce8&&!(0x0,lodash_1[_0x265251(0x249)])(_0x617d3e)&&!(0x0,lodash_1['isNil'])(_0x4003f7))await(0x0,CreateLogTicketService_1[_0x265251(0x24d)])({'userId':_0x617d3e,'queueId':_0x50ea74,'ticketId':_0x449b49,'type':_0x265251(0x242)});else{if(_0x617d3e!==_0x4003f7&&_0x50ea74===_0x2dbce8&&!(0x0,lodash_1['isNil'])(_0x617d3e)&&!(0x0,lodash_1['isNil'])(_0x4003f7))await(0x0,CreateLogTicketService_1['default'])({'userId':_0x617d3e,'queueId':_0x50ea74,'ticketId':_0x449b49,'type':'transfered'}),await(0x0,CreateLogTicketService_1[_0x265251(0x24d)])({'userId':_0x4003f7,'queueId':_0x50ea74,'ticketId':_0x1d4ada['id'],'type':_0x265251(0x21a)});else{if(_0x617d3e!==_0x4003f7&&_0x50ea74!==_0x2dbce8&&!(0x0,lodash_1['isNil'])(_0x617d3e)&&!(0x0,lodash_1[_0x265251(0x249)])(_0x4003f7))await(0x0,CreateLogTicketService_1['default'])({'userId':_0x617d3e,'queueId':_0x50ea74,'ticketId':_0x449b49,'type':_0x265251(0x242)}),await(0x0,CreateLogTicketService_1[_0x265251(0x24d)])({'userId':_0x4003f7,'queueId':_0x2dbce8,'ticketId':_0x1d4ada['id'],'type':_0x265251(0x21a)});else _0x617d3e!==undefined&&(0x0,lodash_1[_0x265251(0x249)])(_0x4003f7)&&_0x50ea74!==_0x2dbce8&&!(0x0,lodash_1[_0x265251(0x249)])(_0x2dbce8)&&await(0x0,CreateLogTicketService_1[_0x265251(0x24d)])({'userId':_0x617d3e,'queueId':_0x50ea74,'ticketId':_0x449b49,'type':_0x265251(0x242)});}}return(_0x1d4ada[_0x265251(0x234)]!==_0x366bfd||_0x1d4ada[_0x265251(0x260)]?.['id']!==_0x617d3e)&&(await _0x538ac5[_0x265251(0x21e)]({'userId':_0x1d4ada[_0x265251(0x1fd)]}),_0x2904dc['to'](_0x366bfd)['emit'](_0x265251(0x222)+_0x1e49c6+_0x265251(0x253),{'action':_0x265251(0x252),'ticketId':_0x1d4ada['id']})),_0x2904dc['to'](_0x1d4ada[_0x265251(0x234)])['to'](_0x265251(0x221))['to'](_0x1d4ada['id'][_0x265251(0x210)]())[_0x265251(0x21d)](_0x265251(0x222)+_0x1e49c6+_0x265251(0x253),{'action':'update','ticket':_0x1d4ada}),{'ticket':_0x1d4ada,'oldStatus':_0x366bfd,'oldUserId':_0x617d3e};}else{if(_0x1b51d3[_0x265251(0x23a)]===_0x265251(0x25d)){if(_0x50ea74!==_0x2dbce8&&_0x617d3e===_0x4003f7&&!(0x0,lodash_1[_0x265251(0x249)])(_0x50ea74)&&!(0x0,lodash_1[_0x265251(0x249)])(_0x2dbce8)){const _0x417ee2=await(0x0,GetTicketWbot_1['default'])(_0x349016),_0x36d77f=_0x265251(0x235)+_0x571ce2?.['name']+_0x265251(0x244),_0x46cb6a=await _0x417ee2[_0x265251(0x200)](_0x349016[_0x265251(0x258)][_0x265251(0x22f)]+'@'+(_0x349016[_0x265251(0x246)]?_0x265251(0x25b):_0x265251(0x213)),{'text':_0x36d77f});await(0x0,wbotMessageListener_1[_0x265251(0x259)])(_0x46cb6a,_0x349016,_0x349016[_0x265251(0x258)],_0x538ac5);}else{if(_0x617d3e!==_0x4003f7&&_0x50ea74===_0x2dbce8&&!(0x0,lodash_1[_0x265251(0x249)])(_0x617d3e)&&!(0x0,lodash_1[_0x265251(0x249)])(_0x4003f7)&&(!_0x349016[_0x265251(0x246)]||_0x29bf91===_0x265251(0x25d))){const _0x5eeee8=await(0x0,GetTicketWbot_1[_0x265251(0x24d)])(_0x349016),_0x5705ca=await(0x0,ShowUserService_1['default'])(_0x4b663e['userId'],_0x1e49c6),_0x2f28f9='‎*Mensagem\x20Automática*:\x0aVocê\x20foi\x20transferido(a)\x20para\x20o\x20atendente\x20*'+_0x5705ca['name']+_0x265251(0x236),_0x5e0349=await _0x5eeee8[_0x265251(0x200)](_0x349016['contact'][_0x265251(0x22f)]+'@'+(_0x349016[_0x265251(0x246)]?_0x265251(0x25b):'s.whatsapp.net'),{'text':_0x2f28f9});await(0x0,wbotMessageListener_1['verifyMessage'])(_0x5e0349,_0x349016,_0x349016[_0x265251(0x258)],_0x538ac5);}else{if(_0x617d3e!==_0x4003f7&&_0x50ea74!==_0x2dbce8&&!(0x0,lodash_1[_0x265251(0x249)])(_0x617d3e)&&!(0x0,lodash_1[_0x265251(0x249)])(_0x4003f7)&&(!_0x349016[_0x265251(0x246)]||_0x29bf91===_0x265251(0x25d))){const _0x699426=await(0x0,GetTicketWbot_1[_0x265251(0x24d)])(_0x349016),_0x27b7b1=await(0x0,ShowUserService_1['default'])(_0x4b663e[_0x265251(0x1fd)],_0x1e49c6),_0x5de2a8=_0x265251(0x235)+_0x571ce2?.[_0x265251(0x23c)]+_0x265251(0x243)+_0x27b7b1['name']+_0x265251(0x236),_0x190bc7=await _0x699426[_0x265251(0x200)](_0x349016[_0x265251(0x258)][_0x265251(0x22f)]+'@'+(_0x349016[_0x265251(0x246)]?_0x265251(0x25b):_0x265251(0x213)),{'text':_0x5de2a8});await(0x0,wbotMessageListener_1[_0x265251(0x259)])(_0x190bc7,_0x349016,_0x349016['contact']);}else{if(_0x617d3e!==undefined&&(0x0,lodash_1[_0x265251(0x249)])(_0x4003f7)&&_0x50ea74!==_0x2dbce8&&!(0x0,lodash_1['isNil'])(_0x2dbce8)){const _0x2c765f=await(0x0,GetTicketWbot_1['default'])(_0x349016),_0x4c531b=_0x265251(0x235)+_0x571ce2?.[_0x265251(0x23c)]+'*\x0aAguarde\x20um\x20momento,\x20iremos\x20atende-lo(a)!',_0xcd7e73=await _0x2c765f[_0x265251(0x200)](_0x349016[_0x265251(0x258)][_0x265251(0x22f)]+'@'+(_0x349016[_0x265251(0x246)]?_0x265251(0x25b):'s.whatsapp.net'),{'text':_0x4c531b});await(0x0,wbotMessageListener_1['verifyMessage'])(_0xcd7e73,_0x349016,_0x349016[_0x265251(0x258)]);}}}}}if(!(0x0,lodash_1[_0x265251(0x249)])(_0x2d544b)){const _0x6ad0b4={'wid':'PVT'+_0x349016[_0x265251(0x209)][_0x265251(0x210)]()[_0x265251(0x22b)]('\x20',''),'ticketId':_0x349016['id'],'contactId':undefined,'body':_0x2d544b,'fromMe':!![],'mediaType':_0x265251(0x20b),'read':!![],'quotedMsgId':null,'ack':0x2,'remoteJid':_0x349016[_0x265251(0x258)]?.[_0x265251(0x262)],'participant':null,'dataJson':null,'ticketTrakingId':null,'isPrivate':!![]};await(0x0,CreateMessageService_1[_0x265251(0x24d)])({'messageData':_0x6ad0b4,'companyId':_0x349016['companyId']});}if(_0x617d3e!==_0x4003f7&&_0x50ea74===_0x2dbce8&&!(0x0,lodash_1['isNil'])(_0x617d3e)&&!(0x0,lodash_1[_0x265251(0x249)])(_0x4003f7))await(0x0,CreateLogTicketService_1[_0x265251(0x24d)])({'userId':_0x617d3e,'queueId':_0x50ea74,'ticketId':_0x449b49,'type':_0x265251(0x242)});else{if(_0x617d3e!==_0x4003f7&&_0x50ea74===_0x2dbce8&&!(0x0,lodash_1['isNil'])(_0x617d3e)&&!(0x0,lodash_1[_0x265251(0x249)])(_0x4003f7))await(0x0,CreateLogTicketService_1['default'])({'userId':_0x617d3e,'queueId':_0x50ea74,'ticketId':_0x449b49,'type':_0x265251(0x242)}),await(0x0,CreateLogTicketService_1[_0x265251(0x24d)])({'userId':_0x4003f7,'queueId':_0x50ea74,'ticketId':_0x349016['id'],'type':_0x265251(0x21a)});else{if(_0x617d3e!==_0x4003f7&&_0x50ea74!==_0x2dbce8&&!(0x0,lodash_1[_0x265251(0x249)])(_0x617d3e)&&!(0x0,lodash_1[_0x265251(0x249)])(_0x4003f7))await(0x0,CreateLogTicketService_1[_0x265251(0x24d)])({'userId':_0x617d3e,'queueId':_0x50ea74,'ticketId':_0x449b49,'type':'transfered'}),await(0x0,CreateLogTicketService_1[_0x265251(0x24d)])({'userId':_0x4003f7,'queueId':_0x2dbce8,'ticketId':_0x349016['id'],'type':_0x265251(0x21a)});else _0x617d3e!==undefined&&(0x0,lodash_1[_0x265251(0x249)])(_0x4003f7)&&_0x50ea74!==_0x2dbce8&&!(0x0,lodash_1[_0x265251(0x249)])(_0x2dbce8)&&await(0x0,CreateLogTicketService_1[_0x265251(0x24d)])({'userId':_0x617d3e,'queueId':_0x50ea74,'ticketId':_0x449b49,'type':_0x265251(0x242)});}}}}return _0x1edae3=_0x571ce2&&_0x571ce2[_0x265251(0x225)]?_0x265251(0x218):_0x1edae3,await _0x349016[_0x265251(0x21e)]({'status':_0x1edae3,'queueId':_0x2dbce8,'userId':_0x4003f7,'isBot':_0x253faf,'queueOptionId':_0x730e70,'amountUsedBotQueues':_0x1edae3==='closed'?0x0:_0x1219aa?_0x1219aa:_0x349016[_0x265251(0x220)],'lastMessage':_0x591e2b?_0x591e2b:_0x349016[_0x265251(0x203)],'useIntegration':_0x550a55,'integrationId':_0x11981e,'typebotSessionId':!_0x550a55?null:_0x349016[_0x265251(0x207)],'typebotStatus':_0x550a55,'unreadMessages':_0x38a081}),_0x538ac5[_0x265251(0x20d)]=(0x0,moment_1[_0x265251(0x24d)])()['toDate'](),_0x538ac5['queueId']=_0x2dbce8,_0x349016=await(0x0,ShowTicketService_1[_0x265251(0x24d)])(_0x349016['id'],_0x1e49c6),_0x1edae3!==undefined&&[_0x265251(0x261)][_0x265251(0x1fe)](_0x1edae3)>-0x1&&!(0x0,lodash_1[_0x265251(0x249)])(_0x617d3e)&&(await(0x0,CreateLogTicketService_1[_0x265251(0x24d)])({'userId':_0x617d3e,'ticketId':_0x449b49,'type':_0x265251(0x261)}),await _0x538ac5['update']({'whatsappId':_0x349016[_0x265251(0x22d)],'startedAt':null,'userId':null})),_0x1edae3!==undefined&&_0x1edae3!==_0x366bfd&&[_0x265251(0x1fa)][_0x265251(0x1fe)](_0x1edae3)>-0x1&&(await _0x538ac5[_0x265251(0x21e)]({'startedAt':(0x0,moment_1[_0x265251(0x24d)])()[_0x265251(0x1fc)](),'ratingAt':null,'rated':![],'whatsappId':_0x349016['whatsappId'],'userId':_0x349016[_0x265251(0x1fd)],'queueId':_0x349016[_0x265251(0x228)]}),await(0x0,CreateLogTicketService_1[_0x265251(0x24d)])({'userId':_0x4003f7,'queueId':_0x349016[_0x265251(0x228)],'ticketId':_0x449b49,'type':_0x366bfd===_0x265251(0x261)?_0x265251(0x1fa):'reopen'})),await _0x538ac5[_0x265251(0x216)](),(_0x349016[_0x265251(0x234)]!==_0x366bfd||_0x349016[_0x265251(0x260)]?.['id']!==_0x617d3e)&&(await _0x538ac5[_0x265251(0x21e)]({'userId':_0x349016[_0x265251(0x1fd)]}),_0x2904dc['to'](_0x366bfd)['emit'](_0x265251(0x222)+_0x1e49c6+_0x265251(0x253),{'action':_0x265251(0x252),'ticketId':_0x349016['id']})),_0x2904dc['to'](_0x349016[_0x265251(0x234)])['to'](_0x265251(0x221))['to'](_0x449b49['toString']())[_0x265251(0x21d)](_0x265251(0x222)+_0x1e49c6+_0x265251(0x253),{'action':_0x265251(0x21e),'ticket':_0x349016}),{'ticket':_0x349016,'oldStatus':_0x366bfd,'oldUserId':_0x617d3e};}catch(_0x56b062){Sentry[_0x265251(0x25a)](_0x56b062);}};function a631_0x3826(_0x187d3d,_0x3ec5c4){const _0x3d127=a631_0x3d12();return a631_0x3826=function(_0x382612,_0x36eeab){_0x382612=_0x382612-0x1f3;let _0x4b6883=_0x3d127[_0x382612];return _0x4b6883;},a631_0x3826(_0x187d3d,_0x3ec5c4);}exports[a631_0x2729cd(0x24d)]=UpdateTicketService;